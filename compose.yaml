volumes:
  watch-db: {}
  keygen-db: {}
  sign-db: {}

networks:
  btc:
    name: btc
    driver: bridge
  db:
    name: db
    driver: bridge

services:
  #########################################################################
  # Bitcoin core
  #------------------------------------------------------------------------
  # Configuration: Regtest Mode
  # - All nodes run in regtest mode for local development and testing
  # - Watch node: Online node with network connectivity
  # - Keygen/Sign nodes: Offline nodes with -maxconnections=0
  #
  # Example of commands to container
  # - enter in container
  #   - $ docker compose exec btc-watch bash
  # - run bitcoin-cli (regtest mode)
  #   - $ docker compose exec btc-watch bitcoin-cli -regtest -rpcuser=xyz -rpcpassword=xyz getnetworkinfo
  # - wallet location (regtest mode)
  #   - /home/bitcoin/.bitcoin/regtest/wallets
  #
  # Note: Using official bitcoin/bitcoin image with specific version tag
  #########################################################################
  btc-watch:
    image: bitcoin/bitcoin:27.1
    container_name: btc-watch
    volumes:
      - ./docker/nodes/btc/data1:/home/bitcoin/.bitcoin
    ports:
      - "${BTC_WATCH_RPC_PORT:-18332}:18443"  # Map to regtest RPC port 18443
    stdin_open: true
    tty: true
    networks:
      - btc
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-regtest", "-rpcuser=xyz", "-rpcpassword=xyz", "getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    command: -printtoconsole

  btc-keygen:
    image: bitcoin/bitcoin:27.1
    container_name: btc-keygen
    volumes:
      - ./docker/nodes/btc/data2:/home/bitcoin/.bitcoin
    ports:
      - "${BTC_KEYGEN_RPC_PORT:-19332}:18443"  # Map to regtest RPC port 18443
    stdin_open: true
    tty: true
    networks:
      - btc
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-regtest", "-rpcuser=xyz", "-rpcpassword=xyz", "getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    command: -maxconnections=0 -printtoconsole

  btc-sign:
    image: bitcoin/bitcoin:27.1
    container_name: btc-sign
    volumes:
      - ./docker/nodes/btc/data3:/home/bitcoin/.bitcoin
    ports:
      - "${BTC_SIGN_RPC_PORT:-20332}:18443"  # Map to regtest RPC port 18443
    stdin_open: true
    tty: true
    networks:
      - btc
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-regtest", "-rpcuser=xyz", "-rpcpassword=xyz", "getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    command: -maxconnections=0 -printtoconsole

  #########################################################################
  # Database
  #########################################################################
  # watch only wallet
  watch-db:
    image: mysql:8.4
    container_name: watch-db
    volumes:
      - watch-db:/var/lib/mysql #this volume should be outside to keep on a permanent basis
      - "./docker/mysql/sqls:/sqls"
      - "./docker/mysql/watch/conf.d:/etc/mysql/conf.d"
      - "./docker/mysql/watch/init.d:/docker-entrypoint-initdb.d"
      #- "./docker/mysql/scripts:/docker-entrypoint-initdb.d"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: watch
      MYSQL_USER: hiromaily
      MYSQL_PASSWORD: hiromaily
      ENV: watch
    ports:
      - "${WATCH_MYSQL_PORT:-3307}:3306"
    networks:
      - db
    healthcheck:
      test:
        ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # keygen wallet
  keygen-db:
    image: mysql:8.4
    container_name: keygen-db
    volumes:
      - keygen-db:/var/lib/mysql #this volume should be outside to keep on a permanent basis
      - "./docker/mysql/sqls:/sqls"
      - "./docker/mysql/keygen/conf.d:/etc/mysql/conf.d"
      - "./docker/mysql/keygen/init.d:/docker-entrypoint-initdb.d"
      #- "./docker/mysql/scripts:/docker-entrypoint-initdb.d"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: keygen
      MYSQL_USER: hiromaily
      MYSQL_PASSWORD: hiromaily
      ENV: keygen
    ports:
      - "${KEYGEN_MYSQL_PORT:-3308}:3306"
    networks:
      - db
    healthcheck:
      test:
        ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # sign wallet
  sign-db:
    image: mysql:8.4
    container_name: sign-db
    volumes:
      - sign-db:/var/lib/mysql #this volume should be outside to keep on a permanent basis
      - "./docker/mysql/sqls:/sqls"
      - "./docker/mysql/sign/conf.d:/etc/mysql/conf.d"
      - "./docker/mysql/sign/init.d:/docker-entrypoint-initdb.d"
      #- "./docker/mysql/scripts:/docker-entrypoint-initdb.d"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: sign
      MYSQL_USER: hiromaily
      MYSQL_PASSWORD: hiromaily
      ENV: sign
    ports:
      - "${SIGN_MYSQL_PORT:-3309}:3306"
    networks:
      - db
    healthcheck:
      test:
        ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
